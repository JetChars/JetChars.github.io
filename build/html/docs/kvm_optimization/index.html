

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>KVM Optimization &mdash; JetChars alpha documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="JetChars alpha documentation" href="../../index.html"/>
        <link rel="next" title="DevStack" href="../devstack/index.html"/>
        <link rel="prev" title="Sahara" href="../sahara/index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> JetChars
          

          
          </a>

          
            
            
              <div class="version">
                0.1.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../cloud_computing.html">Cloud Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/index.html">AWS &#8211; Amazon Web Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws_vpn/index.html">Build VPN with AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker/index.html">Docker</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ceph/ceph.html">Ceph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ceph/ceph_deploy.html">Ceph Deploy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ceph/ceph_issues.html">Ceph Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ceph/ceph_management_platforms.html">Ceph Management Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ceph/ceph_openstack.html">Ceph w/ OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ceph/ceph_ops.html">Ceph Operation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../web/bootstrap.html">bootstrap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web/html.html">HTML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web/web.html">Web Server</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../openstack/index.html">OpenStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nova.html">Nova</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sahara/index.html">Sahara</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">KVM Optimization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#disk">Disk</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#asynchronous-io">Asynchronous IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="#disk-cache-mode">Disk Cache Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#storage-backend">Storage Backend</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#memory">Memory</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#drop-memory-cache">Drop Memory Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hugepages">HugePages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#check-hugepage-status">Check HugePage status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-1gb-hugepage">Enable 1GB HugePage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#anonymous-hugepages-ahp">Anonymous HugePages (AHP)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#transparent-hugepages-thp">Transparent HugePages(THP)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#network">Network</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mtu-size">MTU Size</a></li>
<li class="toctree-l3"><a class="reference internal" href="#turn-off-nic-s-offloads">Turn off NIC&#8217;s offloads</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#improve-instance-s-launch-speed">Improve Instance&#8217;s Launch Speed</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../devstack/index.html">DevStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devstack_dvr/index.html">DevStack with DVR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devstack_t13g/index.html">DevStack Trouble Shooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../o7k_docker/index.html">OpenStack &amp; Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../osp7_director.html">OpenStack Platform 7 Director</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hadoop/index.html">Hadoop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hadoop_conf_tuning/index.html">Hadoop Configuration Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hadoop_hibench/index.html">HiBench - The Hadoop BenchMark Suit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doopshot/index.html">DoopShot</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../linux/freebsd.html">FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/linux.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/linux_disk.html">Linux Disk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/linux_doc.html">Documentation Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/linux_info.html">Get System Infos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/linux_mon.html">Linux Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/linux_net.html">Linux Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/linux_pkg.html">Linux Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/linux_virt.html">Virtualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/shell.html">Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/ubuntu.html">Ubuntu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pxe/index.html">PXE &#8211; Preboot Execution Enviriment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../screen/index.html">Screen - Full-screen window manager</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../git.html">Git &#8211; Extraordinary version contrl software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../github/index.html">GitHub &#8211; Git repository hosting service</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../regex/index.html">Regular Expression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sql/index.html">SQL &#8211; Structured Query Language</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rst.html">reStructured Text (rst)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../md.html">MarkDown (md)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../svg/index.html">Scalable Vector Graphics (SVG)</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../netease_homework/os.html">Operating System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../sort.html">Sorting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_structure.html">Review DataStructure with Pics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../amqp/index.html">AMQP &#8211; Advanced Message Queuing Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rest.html">RESTful API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../microservices/index.html">MicroServices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows/index.html">Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mac.html">Mac as Main OS</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../kickstart/index.html">Kickstart Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">JetChars</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
    <li>KVM Optimization</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/docs/kvm_optimization/index.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kvm-optimization">
<h1>KVM Optimization<a class="headerlink" href="#kvm-optimization" title="Permalink to this headline">¶</a></h1>
<p>Normally kvm instances are managed by virsh, in which instance is called domain. virsh can be used to create, pause, and shutdown domains.</p>
<div class="section" id="disk">
<h2>Disk<a class="headerlink" href="#disk" title="Permalink to this headline">¶</a></h2>
<div class="section" id="asynchronous-io">
<h3>Asynchronous IO<a class="headerlink" href="#asynchronous-io" title="Permalink to this headline">¶</a></h3>
<p>AIO is not enabled by defalut, default value is io=&#8217;threads&#8217;, when AIO enabled, io=&#8217;native&#8217;.
There is no available option to enable AIO, cause &#8216;threads&#8217; mode will improve network storage(cinder)&#8217;s performance <a class="footnote-reference" href="#id4" id="id1">[1]</a>.
So we need to change nova&#8217;s libvirt config file manually.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LibvirtConfigGuestDisk</span><span class="p">(</span><span class="n">LibvirtConfigGuestDevice</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LibvirtConfigGuestDisk</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">root_name</span><span class="o">=</span><span class="s2">&quot;disk&quot;</span><span class="p">,</span>
                                                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backing_store</span> <span class="o">=</span> <span class="bp">None</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">io</span> <span class="o">=</span> <span class="s2">&quot;native&quot;</span>    <span class="c1">#add</span>
</span>    <span class="k">def</span> <span class="nf">format_dom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">LibvirtConfigGuestDisk</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">format_dom</span><span class="p">()</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">driver_discard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">drv</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;driver&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">drv</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver_name</span><span class="p">)</span>
            <span class="o">.</span>
            <span class="o">.</span>
<span class="hll">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1">#add</span>
</span><span class="hll">                <span class="n">drv</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;io&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">io</span><span class="p">)</span>   <span class="c1">#add</span>
</span>            <span class="n">dev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">drv</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Here&#8217;s the location of configuration file.</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># vi /usr/lib/python2.7/dist-packages/nova/virt/libvirt/config.py</span>
vi /opt/stack/nova/nova/virt/libvirt/config.py
</pre></div>
</div>
</div>
<div class="section" id="disk-cache-mode">
<h3>Disk Cache Mode<a class="headerlink" href="#disk-cache-mode" title="Permalink to this headline">¶</a></h3>
<p>disk_cachemodes: <code class="docutils literal"><span class="pre">writethrough</span></code> <code class="docutils literal"><span class="pre">writeback</span></code> <code class="docutils literal"><span class="pre">none(default)</span></code> <code class="docutils literal"><span class="pre">directsync</span></code> <code class="docutils literal"><span class="pre">unsafe</span></code></p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[libvirt]</span>
<span class="na">vif_driver</span> <span class="o">=</span> <span class="s">nova.virt.libvirt.vif.LibvirtGenericVIFDriver inject_partition = -2</span>
<span class="na">live_migration_uri</span> <span class="o">=</span> <span class="s">qemu+ssh://stack@%s/system use_usb_tablet = False</span>
<span class="na">cpu_mode</span> <span class="o">=</span> <span class="s">none</span>
<span class="na">virt_type</span> <span class="o">=</span> <span class="s">kvm</span>
<span class="hll"><span class="na">disk_cachemodes</span> <span class="o">=</span> <span class="s">file=writeback,block=none</span>
</span></pre></div>
</div>
</div>
<div class="section" id="storage-backend">
<h3>Storage Backend<a class="headerlink" href="#storage-backend" title="Permalink to this headline">¶</a></h3>
<p><strong>block backend</strong> performs better than <strong>file backend</strong>.
qcow2 belongs to <em>file backend</em>.</p>
<p><strong>2 ways to realize block backend</strong></p>
<ul class="simple">
<li>cinder volume</li>
<li>local lvm</li>
</ul>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span>  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;qcow2&#39;</span> <span class="na">cache=</span><span class="s">&#39;none&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/opt/stack/data/nova/instances/2f1ed2ce-a466-4dfc-afbe-9029e58fc0ca/disk&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vda&#39;</span> <span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x04&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
<span class="hll"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;block&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span>  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span> <span class="na">cache=</span><span class="s">&#39;none&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">&#39;/dev/disk/by-path/ip-192.168.16.12:3260-iscsi-iqn.2010-10.org.openstack:volume-c86ee1fc-0881-4b85-aa8a-432f8ad1c9cb-lun-1&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vdb&#39;</span> <span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;serial&gt;</span>c86ee1fc-0881-4b85-aa8a-432f8ad1c9cb<span class="nt">&lt;/serial&gt;</span>
  <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x06&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
<span class="hll"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;cdrom&#39;</span><span class="nt">&gt;</span>
</span>   <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span> <span class="na">cache=</span><span class="s">&#39;none&#39;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/opt/stack/data/nova/instances/2f1ed2ce-a466-4dfc-afbe-9029e58fc0ca/disk.config&#39;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hdd&#39;</span> <span class="na">bus=</span><span class="s">&#39;ide&#39;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;readonly/&gt;</span>
   <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;drive&#39;</span> <span class="na">controller=</span><span class="s">&#39;0&#39;</span> <span class="na">bus=</span><span class="s">&#39;1&#39;</span> <span class="na">target=</span><span class="s">&#39;0&#39;</span> <span class="na">unit=</span><span class="s">&#39;1&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="memory">
<h2>Memory<a class="headerlink" href="#memory" title="Permalink to this headline">¶</a></h2>
<div class="section" id="drop-memory-cache">
<h3>Drop Memory Cache<a class="headerlink" href="#drop-memory-cache" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="m">3</span> &gt; /proc/sys/vm/drop_caches
</pre></div>
</div>
</div>
<div class="section" id="hugepages">
<h3>HugePages<a class="headerlink" href="#hugepages" title="Permalink to this headline">¶</a></h3>
<div class="sidebar">
<p class="first sidebar-title">Note</p>
<p>There are two types of Hugepages, <strong>Anonymous</strong> and <strong>Transparent</strong>. Without hugepage, disk I/O drop drastically.</p>
<p><strong>AnonHugePages</strong> stands for the total space of Anonymous Hugepage.
It can be divided by <em>Hugepagesize</em></p>
<p class="last"><strong>HugePages_Total</strong> stands for the total space of Transparent Hugepages.
Equals to <em>vm.nr_hugepages</em> * <em>Hugepagesize</em></p>
</div>
<div class="section" id="check-hugepage-status">
<h4>Check HugePage status<a class="headerlink" href="#check-hugepage-status" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">sudo</span> <span class="pre">sysctl</span> <span class="pre">-a</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">huge</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">vm</span><span class="o">.</span><span class="n">hugepages_treat_as_movable</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">vm</span><span class="o">.</span><span class="n">hugetlb_shm_group</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">vm</span><span class="o">.</span><span class="n">nr_hugepages</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">vm</span><span class="o">.</span><span class="n">nr_hugepages_mempolicy</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">vm</span><span class="o">.</span><span class="n">nr_overcommit_hugepages</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">cat</span> <span class="pre">/proc/meminfo</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">huge</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span>AnonHugePages:      8192 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="enable-1gb-hugepage">
<h4>Enable 1GB HugePage<a class="headerlink" href="#enable-1gb-hugepage" title="Permalink to this headline">¶</a></h4>
<p>Currently, this size only support rhel &amp; centos.
<em>Restarting Host OS</em> is required after the step 1.
After that, hugepage number cannot be changed.</p>
<ol class="arabic">
<li><p class="first">kernel options: <code class="docutils literal"><span class="pre">default_hugepagesz=1G</span> <span class="pre">hugepagesz=1G</span> <span class="pre">hugepages=80</span> <span class="pre">hugepagesz=2M</span> <span class="pre">hugepages=1024</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span>sudo vi /etc/default/grub
grub2-mkconfig
</pre></div>
</div>
</li>
<li><p class="first">Mount 1GB huge pages</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mkdir /dev/hugepages1G
mount -t hugetlbfs -o pagesize=1G none /dev/hugepages1G
mkdir /dev/hugepages2M
mount -t hugetlbfs -o pagesize=2M none /dev/hugepages2M
</pre></div>
</div>
</li>
<li><p class="first">Restart libvirtd</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>systemctl restart libvirtd
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="anonymous-hugepages-ahp">
<h4>Anonymous HugePages (AHP)<a class="headerlink" href="#anonymous-hugepages-ahp" title="Permalink to this headline">¶</a></h4>
<p>kvm instance will use anonymous hugepages by default. AHPs were allocated dynamically, once hugepages are allocated to an instance, they will not be recycled until the instance is destroyed.</p>
<p><strong>Check which process use AHP</strong></p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>ps -fp <span class="sb">`</span>grep AnonHugePages /proc/*/smaps <span class="p">|</span> grep -v <span class="s1">&#39;AnonHugePages:         0 kB&#39;</span> <span class="p">|</span> cut -d/ -f3<span class="sb">`</span>
</pre></div>
</div>
<p><strong>Enable anonymous hugepage</strong></p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>sudo <span class="nb">echo</span> always &gt; /sys/kernel/mm/transparent_hugepage/enabled
sudo <span class="nb">echo</span> madvise &gt; /sys/kernel/mm/transparent_hugepage/defrag
</pre></div>
</div>
</div>
<div class="section" id="transparent-hugepages-thp">
<h4>Transparent HugePages(THP)<a class="headerlink" href="#transparent-hugepages-thp" title="Permalink to this headline">¶</a></h4>
<p>THP is kind of static Hugepage, once its number changed, memory useage goes with it.</p>
<div class="sidebar">
<p class="first sidebar-title">Warning !</p>
<ul class="last simple">
<li>If Nova-Compute Service is not disabled, any changes to libvirt.xml will not take effect.</li>
<li>THPs are known to cause  unexpected node reboots and performance problem with Oracle RAC &amp; JDK</li>
</ul>
</div>
<ol class="arabic">
<li><p class="first">Disable Nova-Compute Service</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">virsh</span> <span class="pre">destroy</span> <span class="pre">&lt;instance&gt;</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">virsh</span> <span class="pre">edit</span> <span class="pre">&lt;instance&gt;</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;memoryBacking&gt;
  &lt;hugepages/&gt;
&lt;/memoryBacking&gt;
</pre></div>
</div>
</li>
<li><dl class="first docutils">
<dt>Allocate THP (2 methods)</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">sudo</span> <span class="pre">sysctl</span> <span class="pre">-w</span> <span class="pre">vm.nr_hugepages=val</span></code></li>
<li><code class="docutils literal"><span class="pre">sudo</span> <span class="pre">echo</span> <span class="pre">val</span> <span class="pre">&gt;</span> <span class="pre">/proc/sys/vm/nr_hugepages</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">virsh</span> <span class="pre">start</span> <span class="pre">&lt;instance&gt;</span></code></p>
</li>
<li><p class="first">Start Nova-Compute Service</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="network">
<h2>Network<a class="headerlink" href="#network" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mtu-size">
<h3>MTU Size<a class="headerlink" href="#mtu-size" title="Permalink to this headline">¶</a></h3>
<p>When using tunnel network (GRE, vxlan) , set the MTU in the Guest to 1400, this will allow for the GRE/vxlan header and no packet fragmentation.</p>
<p>In general, the performance may vary based on the underlying hardware used when VXLAN is configured in Open vSwitch.  But worry not, the ixgbe Linux driver features VXLAN Overlay HW Offloading support and is enabled in the driver by default. <a class="footnote-reference" href="#id5" id="id2">[2]</a></p>
<p>This command enables/disables VXLAN support in the driver:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>ethtool -K ethX tx-udp_tnl-segmentation <span class="o">[</span>off<span class="p">|</span>on<span class="o">]</span>
</pre></div>
</div>
<ul class="simple">
<li>change default dnsmasq conf file at <strong>/etc/neutron/dhcp_agent.ini</strong></li>
</ul>
<div class="highlight-guess"><div class="highlight"><pre><span></span>dnsmasq_config_file = /etc/neutron/dnsmasq-neutron.conf
</pre></div>
</div>
<ul class="simple">
<li>add dhcp option to <strong>/etc/neutron/dnsmasq-neutron.conf</strong></li>
</ul>
<div class="highlight-guess"><div class="highlight"><pre><span></span>dhcp-option-force=26,1400
</pre></div>
</div>
<ul class="simple">
<li>restart Neutron-DHCP service</li>
</ul>
<div class="highlight-shell"><div class="highlight"><pre><span></span><span class="c1"># sudo pkill -1 neutron-dhcp-agent</span>
service neutron-dhcp-agent restart
</pre></div>
</div>
</div>
<div class="section" id="turn-off-nic-s-offloads">
<h3>Turn off NIC&#8217;s offloads<a class="headerlink" href="#turn-off-nic-s-offloads" title="Permalink to this headline">¶</a></h3>
<p>Turn <strong>TSO/LRO</strong> and <strong>GRO/GSO</strong> off on the instance physical machine for traffic to work, will help improve instance&#8217;s performance greatly, especially <strong>GRO</strong> . <a class="footnote-reference" href="#id6" id="id3">[3]</a></p>
<ul>
<li><p class="first">Check offloads&#8217; status</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ ethtool -k enp6s0f1
tcp-segmentation-offload: on
        tx-tcp-segmentation: on
        tx-tcp-ecn-segmentation: off [fixed]
        tx-tcp6-segmentation: on
udp-fragmentation-offload: off [fixed]
generic-segmentation-offload: on
generic-receive-offload: off
large-receive-offload: off
</pre></div>
</div>
</li>
<li><p class="first">Turn offloads off</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ sudo ethtool -K enp6s0f1 tso off lro off gro off gso off
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="improve-instance-s-launch-speed">
<h2>Improve Instance&#8217;s Launch Speed<a class="headerlink" href="#improve-instance-s-launch-speed" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Resize qcow2 image&#8217;s disk size to fit target flavor&#8217;s disk size</li>
</ul>
<div class="highlight-shell"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># guestfish - the libguestfs Filesystem Interactive SHell</span>
sudo apt-get install libguestfs-tools -y --force-yes 2&gt;/dev/null <span class="o">||</span> sudo yum install -y libguestfs-tools
<span class="c1"># create an empty qcow2 image with target size</span>
qemu-img create -f qcow2 image_name image_size
<span class="c1"># use guestfish to resize it</span>
virt-resize -d --expand /dev/sda1 src_image dst_image
qemu-img info dst_image
</pre></div>
</td></tr></table></div>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://blueprints.launchpad.net/nova/+spec/improve-nova-kvm-io-support">https://blueprints.launchpad.net/nova/+spec/improve-nova-kvm-io-support</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://software.intel.com/en-us/blogs/2015/01/29/optimizing-the-virtual-networks-with-vxlan-overlay-offloading">https://software.intel.com/en-us/blogs/2015/01/29/optimizing-the-virtual-networks-with-vxlan-overlay-offloading</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://www.rdoproject.org/Using_GRE_tenant_networks">https://www.rdoproject.org/Using_GRE_tenant_networks</a></td></tr>
</tbody>
</table>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../devstack/index.html" class="btn btn-neutral float-right" title="DevStack" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../sahara/index.html" class="btn btn-neutral" title="Sahara" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, JetChars.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'alpha',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>