

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Enable DVR with DevStack &mdash; JetChars 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="JetChars 0.1 documentation" href="../../index.html"/>
        <link rel="next" title="KVM Optimization" href="../kvm_optimization/index.html"/>
        <link rel="prev" title="Welcome to jetchars’s documentation!" href="../../index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../index.html" class="icon icon-home"> JetChars
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="simple">
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="">Enable DVR with DevStack</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#brief-intro">Brief Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-network-node">Configure Network Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-compute-node">Configure Compute Node</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../kvm_optimization/index.html">KVM Optimization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../kvm_optimization/index.html#disk-optimization">Disk Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../kvm_optimization/index.html#asynchronous-io">Asynchronous IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../kvm_optimization/index.html#disk-cache-mode">Disk Cache Mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_optimization/index.html#memory-optimization">Memory Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../kvm_optimization/index.html#transparent-hugepage">Transparent HugePage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../kvm_optimization/index.html#network-optimization">Network Optimization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../kvm_optimization/index.html#mtu-size">MTU Size</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../hibench_intro/index.html">HiBench - The Hadoop BenchMark Suit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../hibench_intro/index.html#what-is-hibench">What is HiBench?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hibench_intro/index.html#benchmark-types">BenchMark Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hibench_intro/index.html#configuration-running-scripts">Configuration &amp; Running scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hibench_intro/index.html#default-configurations">Default Configurations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../hibench_intro/index.html#dfsioe">DFSIOE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hibench_intro/index.html#sort">Sort</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hibench_intro/index.html#wordcount">WordCount</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hibench_intro/index.html#k-means">k-means</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation_tools/index.html">Linux Documentation Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../documentation_tools/index.html#pandoc-universal-document-converter">Pandoc - Universal document converter</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">JetChars</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
    <li>Enable DVR with DevStack</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/docs/enable_dvr_with_devstack/index.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="enable-dvr-with-devstack">
<h1>Enable DVR with DevStack<a class="headerlink" href="#enable-dvr-with-devstack" title="Permalink to this headline">¶</a></h1>
<p>DVR is short for distributed virtual router, with this feature enabled packets flow with floating IP will no longer send to network node. It helps to alleviate network node&#8217;s pressure greatly when large amount of north-south data flow occurs. <a class="footnote-reference" href="#id4" id="id1">[1]</a></p>
<div class="section" id="brief-intro">
<h2>Brief Intro<a class="headerlink" href="#brief-intro" title="Permalink to this headline">¶</a></h2>
<p>In order to enable distributed router on each compute-node, Neutron-metadata-agent and Neutron-L3-agent are both needed. So we need to add <strong>q-meta</strong> and <strong>q-l3</strong> as well as <em>q-agt</em> on each computer node&#8217;s <code class="docutils literal"><span class="pre">local.conf</span></code> file.</p>
<img alt="../../_images/image1.png" src="../../_images/image1.png" />
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Currently devstack doesn&#8217;t support deploying DVR on GRE tunnel <a class="footnote-reference" href="#id5" id="id2">[2]</a> , and tunnel type has been hard coded to vxlan mode, the following is a part of devstack&#8217;s code <code class="docutils literal"><span class="pre">lib/neutron_plugins/ml2</span></code>:</p>
</div>
<img alt="../../_images/image2.png" src="../../_images/image2.png" />
<p>With DVR, floating IPs can be accessed directly from each compute node, but SNAT still need to be centralized to network node.</p>
<img alt="../../_images/image3.png" src="../../_images/image3.png" />
</div>
<div class="section" id="configure-network-node">
<h2>Configure Network Node<a class="headerlink" href="#configure-network-node" title="Permalink to this headline">¶</a></h2>
<p>Here&#8217;s the neutron configuration part of <code class="docutils literal"><span class="pre">local.conf</span></code> on network node.</p>
<div class="highlight-shell"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># Neutron-vxlan-tunnel-DVR</span>
<span class="c">##########################</span>
ENABLED_SERVICES+<span class="o">=</span>,q-svc,q-agt,q-dhcp,q-l3,q-meta,neutron
<span class="nv">Q_FLOATING_ALLOCATION_POOL</span><span class="o">=</span><span class="nv">start</span><span class="o">=</span>192.168.137.166,end<span class="o">=</span>192.168.137.253
<span class="nv">Q_ROUTER_NAME</span><span class="o">=</span>default_router
<span class="nv">PUBLIC_NETWORK_GATEWAY</span><span class="o">=</span>192.168.137.254
<span class="nv">FLOATING_RANGE</span><span class="o">=</span>192.168.0.0/16

<span class="nv">FIXED_RANGE</span><span class="o">=</span>10.1.1.0/24
<span class="nv">FIXED_NETWORK_SIZE</span><span class="o">=</span>256
<span class="nv">NETWORK_GATEWAY</span><span class="o">=</span>10.1.1.1

<span class="nv">Q_PLUGIN</span><span class="o">=</span>ml2
<span class="nv">Q_ML2_TENANT_NETWORK_TYPE</span><span class="o">=</span>vxlan
<span class="nv">TUNNEL_ENDPOINT_IP</span><span class="o">=</span>192.168.1.37
<span class="hll"><span class="nv">Q_DVR_MODE</span><span class="o">=</span>dvr_snat
</span><span class="hll"><span class="nv">Q_SERVICE_PLUGIN_CLASSES</span><span class="o">=</span>neutron.services.l3_router.l3_router_plugin.L3RouterPlugin
</span><span class="hll"><span class="nv">Q_ML2_PLUGIN_MECHANISM_DRIVERS</span><span class="o">=</span>openvswitch,linuxbridge,l2population
</span></pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">DVR mode can be <strong>dvr_snat</strong> , <strong>dvr</strong> or <strong>legacy</strong>. <em>Legacy</em> is Q_DVR_MODE &#8216;s default value, <em>dvr_snat</em> is for network node which enables snat router, and <em>dvr</em> mode is for compute node.</p>
</div>
<p><strong>L2population</strong> is needed by DVR. The L2 Population driver enables broadcast, multicast, and unicast traffic to scale out on large overlay networks. This traffic is sent to the relevant agent via encapsulation as a targeted unicast. <a class="footnote-reference" href="#id6" id="id3">[3]</a></p>
<img alt="../../_images/image4.png" src="../../_images/image4.png" />
<p>After Installation you might see 3 bridges and 4 namespaces on network node.</p>
<img alt="../../_images/image5.png" src="../../_images/image5.png" />
<img alt="../../_images/image6.png" src="../../_images/image6.png" />
<p>Namespace fip* is for floating IP accessing. qdhcp* is for allocating IP addresses. snat* is for SNAT function. qrouter* only serves VM in current host.</p>
</div>
<div class="section" id="configure-compute-node">
<h2>Configure Compute Node<a class="headerlink" href="#configure-compute-node" title="Permalink to this headline">¶</a></h2>
<p>The following is the neutron configuration part of <code class="docutils literal"><span class="pre">local.conf</span></code> on compute node</p>
<div class="highlight-shell"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># Neutron-vxlan-tunnel-DVR</span>
<span class="c">##########################</span>
ENABLED_SERVICES+<span class="o">=</span> q-agt,q-l3,q-meta, neutron
<span class="nv">Q_PLUGIN</span><span class="o">=</span>ml2
<span class="nv">Q_ML2_TENANT_NETWORK_TYPE</span><span class="o">=</span>vxlan
<span class="nv">TUNNEL_ENDPOINT_IP</span><span class="o">=</span>192.168.1.34
<span class="hll"><span class="nv">Q_DVR_MODE</span><span class="o">=</span>dvr
</span><span class="hll"><span class="nv">Q_SERVICE_PLUGIN_CLASSES</span><span class="o">=</span>neutron.services.l3_router.l3_router_plugin.L3RouterPlugin
</span><span class="hll"><span class="nv">Q_ML2_PLUGIN_MECHANISM_DRIVERS</span><span class="o">=</span>openvswitch,linuxbridge,l2population
</span></pre></div>
</td></tr></table></div>
<p>After installation you might see 3 bridges and 2 namespaces.</p>
<img alt="../../_images/image7.png" src="../../_images/image7.png" />
<img alt="../../_images/image8.png" src="../../_images/image8.png" />
<p>fip* and qrouter* did the same job as two virtual devices on network node.
We still need to do some configurations manually.</p>
<ol class="arabic simple">
<li>Add an free physical device(NIC) to br-ex</li>
</ol>
<div class="highlight-shell"><div class="highlight"><pre><span class="nv">$ </span>sudo ovs-vsctl add-port br-ex eth1
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Allocate an IP for br-ex as a gateway</li>
</ol>
<div class="highlight-shell"><div class="highlight"><pre><span class="nv">$ </span>sudo ifconfig br-ex 192.168.137.253
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Add a route to floating network via fip*</li>
</ol>
<p>Before we adding this route, we need to know fip&#8217;s IP address.</p>
<img alt="../../_images/image9.png" src="../../_images/image9.png" />
<p>We use the IP on fg* .</p>
<div class="highlight-shell"><div class="highlight"><pre><span class="nv">$ </span>sudo ip route add 192.168.0.0/16 via 192.168.137.171
</pre></div>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://wiki.openstack.org/wiki/Neutron/DVR/HowTo">https://wiki.openstack.org/wiki/Neutron/DVR/HowTo</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="https://blueprints.launchpad.net/neutron/+spec/neutron-ovs-dvr">https://blueprints.launchpad.net/neutron/+spec/neutron-ovs-dvr</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://wiki.openstack.org/wiki/Neutron/DVR_L2_Agent">https://wiki.openstack.org/wiki/Neutron/DVR_L2_Agent</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../kvm_optimization/index.html" class="btn btn-neutral float-right" title="KVM Optimization" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../index.html" class="btn btn-neutral" title="Welcome to jetchars’s documentation!" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, JetChars.
    </p>
  </div>

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>